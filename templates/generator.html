<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Outfit Generator - AesCLO</title>
    <link rel="stylesheet" href="static/css/generatorStyle.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Graphik-Regular-Web&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Righteous&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header>
      <div class="logo">AesCLO</div>
      <nav>
        <a href="{{ url_for('home') }}" class="nav-btn {% if request.endpoint == 'home' %}active{% endif %}" {% if request.endpoint == 'home' %}aria-current="page"{% endif %}>
          <span class="material-symbols-outlined">home</span>
          Home
        </a>
        <a href="{{ url_for('upload_page') }}" class="nav-btn {% if request.endpoint == 'upload_page' %}active{% endif %}" {% if request.endpoint == 'upload_page' %}aria-current="page"{% endif %}>
          <span class="material-symbols-outlined">cloud_upload</span>
          Upload
        </a>
        <a href="{{ url_for('wardrobe') }}" class="nav-btn {% if request.endpoint == 'wardrobe' %}active{% endif %}" {% if request.endpoint == 'wardrobe' %}aria-current="page"{% endif %}>
          <span class="material-symbols-outlined">checkroom</span>
          Wardrobe
        </a>
        <a href="{{ url_for('generator') }}" class="nav-btn {% if request.endpoint == 'generator' %}active{% endif %}" {% if request.endpoint == 'generator' %}aria-current="page"{% endif %}>
          <span class="material-symbols-outlined">auto_awesome</span>
          Generator
        </a>
        <a href="{{ url_for('saved_outfits') }}" class="nav-btn {% if request.endpoint == 'saved_outfits' %}active{% endif %}" {% if request.endpoint == 'saved_outfits' %}aria-current="page"{% endif %}>
          <span class="material-symbols-outlined">bookmark</span>
          Favorites
        </a>
        <a href="{{ url_for('logout') }}" class="nav-btn logout-btn">
          <span class="material-symbols-outlined">logout</span>
          Logout
        </a>
      </nav>
    </header>

    <section class="generator-content">
      <div class="content">
        <h1>Outfit Generator</h1>
        <p class="subtitle">
          Create stylish outfit combinations from your personal wardrobe.
        </p>

        <div class="generator-container">
          <div class="generator-options">
            <div class="option-label">Generation Mode:</div>
            <div class="options-container">
              <label class="option-btn active" for="randomMode">
                <input type="radio" id="randomMode" name="generationMode" value="random" checked>
                <span class="material-symbols-outlined">shuffle</span>
                <span>Random</span>
              </label>
              <label class="option-btn" for="colorCoordinatedMode">
                <input type="radio" id="colorCoordinatedMode" name="generationMode" value="color">
                <span class="material-symbols-outlined">palette</span>
                <span>Color Coordinated</span>
              </label>
              <label class="option-btn" for="occasionMode">
                <input type="radio" id="occasionMode" name="generationMode" value="occasion">
                <span class="material-symbols-outlined">event</span>
                <span>Occasion Based</span>
              </label>
              <label class="option-btn" for="weatherMode">
                <input type="radio" id="weatherMode" name="generationMode" value="weather">
                <span class="material-symbols-outlined">thermostat</span>
                <span>Weather Based</span>
              </label>              
            </div>

            <div id="randomOptions" class="random-options">
              <div class="option-explanation">
                <span class="material-symbols-outlined">casino</span>
                <p>Explore unexpected combinations from your wardrobe with our completely random selection algorithm.</p>
              </div>
            </div>
            
            <div id="colorOptions" class="color-options" style="display: none;">
              <div class="option-explanation">
                <span class="material-symbols-outlined">auto_fix_high</span>
                <p>Select a color from your wardrobe below. We'll build a coordinated outfit featuring this color.</p>
              </div>
              
              <div class="color-selection-container">
                <div class="color-selection-label">Select a color for your outfit:</div>
                <div class="color-palette" id="colorPalette">
                  <!-- Color chips will be dynamically loaded -->
                  <div class="color-loading">
                    <span class="material-symbols-outlined spinning">refresh</span>
                    <span>Loading available colors...</span>
                  </div>
                </div>
                <div class="color-selection-info">
                  <span id="selectedColorDisplay">No color selected</span>
                  <button id="clearColorSelection" class="btn clear-btn" style="display: none;">
                    <span class="material-symbols-outlined">backspace</span>
                    Clear
                  </button>
                </div>
              </div>
            </div>

            <div id="occasionOptions" class="occasion-options" style="display: none;">
              <div class="option-explanation">
                <span class="material-symbols-outlined">calendar_today</span>
                <p>Select an occasion below and we'll create an outfit suitable for that specific occasion.</p>
              </div>
              
              <div class="occasion-selection-container">
                <div class="occasion-selection-label">Select an occasion for your outfit:</div>
                <div class="occasion-buttons">
                  <button class="occasion-btn" data-occasion="casual">
                    <span class="material-symbols-outlined">weekend</span>
                    <span>Casual</span>
                  </button>
                  <button class="occasion-btn" data-occasion="work/professional">
                    <span class="material-symbols-outlined">business_center</span>
                    <span>Work/Professional</span>
                  </button>
                  <button class="occasion-btn" data-occasion="formal">
                    <span class="material-symbols-outlined">local_bar</span>
                    <span>Formal</span>
                  </button>
                  <button class="occasion-btn" data-occasion="athletic/sport">
                    <span class="material-symbols-outlined">fitness_center</span>
                    <span>Athletic/Sport</span>
                  </button>
                  <button class="occasion-btn" data-occasion="lounge/sleepwear">
                    <span class="material-symbols-outlined">hotel</span>
                    <span>Lounge/Sleepwear</span>
                  </button>
                </div>
                <div class="occasion-selection-info">
                  <span id="selectedOccasionDisplay">No occasion selected</span>
                  <button id="clearOccasionSelection" class="btn clear-btn" style="display: none;">
                    <span class="material-symbols-outlined">backspace</span>
                    Clear
                  </button>
                </div>
              </div>
            </div>
            <div id="weatherOptions" class="weather-options" style="display: none;">
              <div class="option-explanation">
                <span class="material-symbols-outlined">wb_sunny</span>
                <p>Generate an outfit based on current weather conditions. Enter your location to get real-time weather data, or manually select weather conditions.</p>
              </div>
              
              <div class="weather-selection-container">
                <div class="weather-selection-tabs">
                  <button class="weather-tab active" data-tab="location-tab">Get Weather by Location</button>
                  <button class="weather-tab" data-tab="manual-tab">Enter Weather Manually</button>
                </div>
                
                <div id="location-tab" class="weather-tab-content">
                  <div class="location-input">
                    <label for="locationInput">Enter your city or ZIP code:</label>
                    <div class="location-search">
                      <input type="text" id="locationInput" placeholder="e.g. New York or 10001">
                      <button id="getWeatherBtn" class="btn small-btn">
                        <span class="material-symbols-outlined">search</span>
                        Get Weather
                      </button>
                    </div>
                  </div>
                  
                  <div id="weatherInfo" class="weather-info" style="display: none;">
                    <div class="weather-data">
                      <div class="weather-header">
                        <span id="weatherLocation" class="weather-location">New York, NY</span>
                        <span id="weatherIcon" class="material-symbols-outlined">sunny</span>
                      </div>
                      <div class="weather-details">
                        <div class="weather-temp">
                          <span id="weatherTemp">72</span>°F
                        </div>
                        <div class="weather-condition" id="weatherCondition">Sunny</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div id="manual-tab" class="weather-tab-content" style="display: none;">
                  <div class="manual-weather-selection">
                    <div class="manual-weather-row">
                      <label>Weather Condition:</label>
                      <div class="weather-buttons">
                        <button class="weather-condition-btn" data-condition="sunny">
                          <span class="material-symbols-outlined">sunny</span>
                          <span>Sunny</span>
                        </button>
                        <button class="weather-condition-btn" data-condition="cloudy">
                          <span class="material-symbols-outlined">cloud</span>
                          <span>Cloudy</span>
                        </button>
                        <button class="weather-condition-btn" data-condition="rain">
                          <span class="material-symbols-outlined">rainy</span>
                          <span>Rain</span>
                        </button>
                        <button class="weather-condition-btn" data-condition="snow">
                          <span class="material-symbols-outlined">ac_unit</span>
                          <span>Snow</span>
                        </button>
                      </div>
                    </div>
                    
                    <div class="manual-weather-row">
                      <label for="temperatureInput">Temperature (°F):</label>
                      <div class="temperature-input">
                        <input type="number" id="temperatureInput" min="-20" max="120" value="70">
                        <span class="temperature-unit">°F</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="weather-selection-info">
                  <span id="selectedWeatherDisplay">No weather conditions selected</span>
                  <button id="clearWeatherSelection" class="btn clear-btn" style="display: none;">
                    <span class="material-symbols-outlined">backspace</span>
                    Clear
                  </button>
                </div>
              </div>
            </div>
          </div>

          <button id="generateBtn" class="btn generate-btn">
            <span class="material-symbols-outlined">auto_awesome</span>
            Generate Outfit
          </button>

          <div id="outfitDisplay" class="outfit-display">
            <div class="preview-placeholder">
              <span class="material-symbols-outlined">checkroom</span>
              <p>Your outfit will appear here</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Image enlargement modal -->
    <div id="imageModal" class="modal">
      <div class="modal-content">
        <button class="close-modal">
          <span class="material-symbols-outlined">close</span>
        </button>
        <img id="enlargedImage" class="modal-image" src="" alt="Enlarged clothing item">
        <div id="itemDetails" class="item-details"></div>
      </div>
    </div>

    <footer>
      <p>&copy; 2025 AesCLO - Your Personal Wardrobe Assistant</p>
    </footer>

    <script>
      // Fetch wardrobe data from backend
      async function fetchWardrobe() {
        const response = await fetch("/get_wardrobe");
        return response.json();
      }

      // Global variables to store the current outfit items
      let currentOutfit = {
        top: null,
        bottom: null,
        shoe: null
      };

      // Function to load user's color palette
      async function loadUserColorPalette() {
        try {
          const colorPalette = document.getElementById('colorPalette');
          colorPalette.innerHTML = `
            <div class="color-loading">
              <span class="material-symbols-outlined spinning">refresh</span>
              <span>Loading available colors...</span>
            </div>
          `;
          
          const response = await fetch('/get_wardrobe_colors');
          const result = await response.json();
          
          if (result.success) {
            colorPalette.innerHTML = ''; // Clear loading message
            
            // Add the "Random Color" chip first
            const randomColorChip = document.createElement('div');
            randomColorChip.className = 'color-chip random-color-chip';
            randomColorChip.setAttribute('data-color', 'random');
            randomColorChip.style = `background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet);`;
            randomColorChip.innerHTML = `<span class="color-name">Random</span>`;
            colorPalette.appendChild(randomColorChip);
            
            if (result.colors && result.colors.length > 0) {
              // Color map for the hex values
              const colorMap = {
                'black': '#000000',
                'white': '#FFFFFF',
                'navy': '#000080',
                'blue': '#0000FF',
                'red': '#FF0000',
                'green': '#008000',
                'purple': '#800080',
                'pink': '#FFC0CB',
                'yellow': '#FFFF00',
                'orange': '#FFA500',
                'brown': '#8B4513',
                'gray': '#808080',
                'beige': '#F5F5DC',
                'turquoise': '#40E0D0',
                'teal': '#008080'
                // Add any other colors your system might detect
              };
              
              // Add color chips for each color in the user's wardrobe
              result.colors.forEach(color => {
                const backgroundColor = colorMap[color] || '#888888'; // Fallback color
                const borderStyle = (color === 'white') ? 'border: 1px solid #ddd;' : '';
                
                const colorChip = document.createElement('div');
                colorChip.className = 'color-chip';
                colorChip.setAttribute('data-color', color);
                colorChip.style = `background-color: ${backgroundColor}; ${borderStyle}`;
                colorChip.innerHTML = `<span class="color-name">${color.charAt(0).toUpperCase() + color.slice(1)}</span>`;
                
                colorPalette.appendChild(colorChip);
              });
              
              // Add click event listeners after all chips are created
              setupColorChipListeners();
            } else {
              // Handle the case where user doesn't have any colors yet
              colorPalette.innerHTML = `
                <div class="no-colors-message">
                  <span class="material-symbols-outlined">info</span>
                  <p>Upload more clothing items to see available colors</p>
                </div>
              `;
            }
          } else {
            colorPalette.innerHTML = `
              <div class="no-colors-message">
                <span class="material-symbols-outlined">error</span>
                <p>Failed to load colors. Please try again.</p>
              </div>
            `;
          }
        } catch (error) {
          console.error("Error loading color palette:", error);
          document.getElementById('colorPalette').innerHTML = `
            <div class="no-colors-message">
              <span class="material-symbols-outlined">error</span>
              <p>Error loading colors. Please try again.</p>
            </div>
          `;
        }
      }
      
      // Set up color chip click event listeners
      function setupColorChipListeners() {
        const colorChips = document.querySelectorAll('.color-chip');
        const selectedColorDisplay = document.getElementById('selectedColorDisplay');
        const clearColorBtn = document.getElementById('clearColorSelection');
        
        colorChips.forEach(chip => {
          chip.addEventListener('click', function() {
            // If this chip is already selected, deselect it
            if (this.classList.contains('selected')) {
              this.classList.remove('selected');
              selectedColorDisplay.textContent = "No color selected";
              clearColorBtn.style.display = 'none';
            } else {
              // Remove selected class from all chips
              colorChips.forEach(c => c.classList.remove('selected'));
              
              // Select this chip
              this.classList.add('selected');
              const colorName = this.getAttribute('data-color');
              
              if (colorName === 'random') {
                selectedColorDisplay.textContent = "Selected: Random";
              } else {
                selectedColorDisplay.textContent = `Selected: ${colorName.charAt(0).toUpperCase() + colorName.slice(1)}`;
              }
              
              clearColorBtn.style.display = 'inline-flex';
            }
          });
        });
      }

      // Set up occasion button click event listeners
      function setupOccasionButtonListeners() {
        const occasionBtns = document.querySelectorAll('.occasion-btn');
        const selectedOccasionDisplay = document.getElementById('selectedOccasionDisplay');
        const clearOccasionBtn = document.getElementById('clearOccasionSelection');
        
        occasionBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            // If this button is already selected, deselect it
            if (this.classList.contains('selected')) {
              this.classList.remove('selected');
              selectedOccasionDisplay.textContent = "No occasion selected";
              clearOccasionBtn.style.display = 'none';
            } else {
              // Remove selected class from all buttons
              occasionBtns.forEach(b => b.classList.remove('selected'));
              
              // Select this button
              this.classList.add('selected');
              const occasionName = this.getAttribute('data-occasion');
              selectedOccasionDisplay.textContent = `Selected: ${occasionName.charAt(0).toUpperCase() + occasionName.slice(1)}`;
              clearOccasionBtn.style.display = 'inline-flex';
            }
          });
        });
        
        // Set up clear selection button
        clearOccasionBtn.addEventListener('click', function() {
          occasionBtns.forEach(b => b.classList.remove('selected'));
          selectedOccasionDisplay.textContent = "No occasion selected";
          this.style.display = 'none';
        });
      }

      // Toggle mode selection
      document.querySelectorAll('input[name="generationMode"]').forEach(radioBtn => {
        radioBtn.addEventListener('change', function() {
          // Toggle active class on labels
          document.querySelectorAll('.option-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          this.parentElement.classList.add('active');
          
          // Show/hide option explanations based on selection
          const randomOptions = document.getElementById('randomOptions');
          const colorOptions = document.getElementById('colorOptions');
          const occasionOptions = document.getElementById('occasionOptions');
          
          if (this.value === 'color') {
            colorOptions.style.display = 'block';
            randomOptions.style.display = 'none';
            occasionOptions.style.display = 'none';
            // Load the user's color palette when color mode is selected
            loadUserColorPalette();
          } else if (this.value === 'occasion') {
            colorOptions.style.display = 'none';
            randomOptions.style.display = 'none';
            occasionOptions.style.display = 'block';
          } else {
            colorOptions.style.display = 'none';
            randomOptions.style.display = 'block';
            occasionOptions.style.display = 'none';
          }
        });
      });

      // Random outfit generation
      async function generateRandomOutfit() {
        const wardrobe = await fetchWardrobe();
        const outfitDisplay = document.getElementById("outfitDisplay");

        if (wardrobe.tops.length < 1 || wardrobe.shoes.length < 1) {
          outfitDisplay.innerHTML = `
            <div class="alert alert-warning">
              <span class="material-symbols-outlined">warning</span>
              <span>You need at least one top and one pair of shoes in your wardrobe to generate an outfit.</span>
            </div>
          `;
          return;
        }

        // Randomly select a top
        const top = wardrobe.tops[Math.floor(Math.random() * wardrobe.tops.length)];
        
        // Instead of trying to use random selection for complete top outfits,
        // we'll make an API call to get proper outfit data
        try {
          // Show loading state
          outfitDisplay.innerHTML = `
            <div class="loading-spinner">
              <span class="material-symbols-outlined spinning">refresh</span>
              <p>Generating random outfit...</p>
            </div>
          `;
          
          // Use the color-coordinated endpoint with random color option
          const response = await fetch('/generate_color_outfit', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              random_color: true
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            // Store current outfit
            currentOutfit.top = result.top;
            currentOutfit.bottom = result.bottom;
            currentOutfit.shoe = result.shoes;
            
            // Display the outfit - the API will handle complete tops correctly
            displayOutfit(result.top, result.bottom, result.shoes, "random");
          } else {
            // Fall back to simple random selection if API call fails
            const shoe = wardrobe.shoes[Math.floor(Math.random() * wardrobe.shoes.length)];
            let bottom = null;
            
            // For the fallback, assume it's not a complete top since we can't tell
            if (wardrobe.bottoms.length > 0) {
              bottom = wardrobe.bottoms[Math.floor(Math.random() * wardrobe.bottoms.length)];
            }
            
            // Store current outfit
            currentOutfit.top = top;
            currentOutfit.bottom = bottom;
            currentOutfit.shoe = shoe;
            
            // Display the outfit
            displayOutfit(top, bottom, shoe, "random");
          }
        } catch (error) {
          console.error("Error generating random outfit:", error);
          
          // Fall back to simple random selection if the API call fails
          const shoe = wardrobe.shoes[Math.floor(Math.random() * wardrobe.shoes.length)];
          let bottom = null;
          
          // For the fallback, assume it's not a complete top since we can't tell
          if (wardrobe.bottoms.length > 0) {
            bottom = wardrobe.bottoms[Math.floor(Math.random() * wardrobe.bottoms.length)];
          }
          
          // Store current outfit
          currentOutfit.top = top;
          currentOutfit.bottom = bottom;
          currentOutfit.shoe = shoe;
          
          // Display the outfit
          displayOutfit(top, bottom, shoe, "random");
        }
      }

      // Color-coordinated outfit generation
      async function generateColorOutfit() {
        const outfitDisplay = document.getElementById("outfitDisplay");
        
        try {
          // Show loading state
          outfitDisplay.innerHTML = `
            <div class="loading-spinner">
              <span class="material-symbols-outlined spinning">refresh</span>
              <p>Generating color-coordinated outfit...</p>
            </div>
          `;
          
          // Check if a color is selected
          const selectedColorChip = document.querySelector('.color-chip.selected');
          const selectedColor = selectedColorChip ? selectedColorChip.getAttribute('data-color') : null;
          
          if (!selectedColor) {
            outfitDisplay.innerHTML = `
              <div class="alert alert-warning">
                <span class="material-symbols-outlined">palette</span>
                <span>Please select a color for your outfit first.</span>
              </div>
            `;
            return;
          }
          
          // If random color is selected, we'll pass a special parameter
          const isRandomColor = selectedColor === 'random';
          
          const response = await fetch('/generate_color_outfit', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              coordination_style: 'color-based',
              base_color: isRandomColor ? 'random' : selectedColor,
              random_color: isRandomColor
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            // Store current outfit
            currentOutfit.top = result.top;
            currentOutfit.bottom = result.bottom;
            currentOutfit.shoe = result.shoes;
            
            // Add the base color information to the UI
            const coordinationStyle = `color-coordinated-${result.base_color}`;
            
            displayOutfit(result.top, result.bottom, result.shoes, coordinationStyle);
          } else {
            outfitDisplay.innerHTML = `
              <div class="alert alert-warning">
                <span class="material-symbols-outlined">warning</span>
                <span>${result.message}</span>
              </div>
            `;
          }
        } catch (error) {
          console.error("Error generating outfit:", error);
          outfitDisplay.innerHTML = `
            <div class="alert alert-warning">
              <span class="material-symbols-outlined">error</span>
              <span>Failed to generate outfit. Please try again.</span>
            </div>
          `;
        }
      }

      // Occasion-based outfit generation
      async function generateOccasionOutfit() {
        const outfitDisplay = document.getElementById("outfitDisplay");
        
        try {
          // Show loading state
          outfitDisplay.innerHTML = `
            <div class="loading-spinner">
              <span class="material-symbols-outlined spinning">refresh</span>
              <p>Generating occasion-based outfit...</p>
            </div>
          `;
          
          // Check if an occasion is selected
          const selectedOccasionBtn = document.querySelector('.occasion-btn.selected');
          const selectedOccasion = selectedOccasionBtn ? selectedOccasionBtn.getAttribute('data-occasion') : null;
          
          if (!selectedOccasion) {
            outfitDisplay.innerHTML = `
              <div class="alert alert-warning">
                <span class="material-symbols-outlined">event</span>
                <span>Please select an occasion for your outfit first.</span>
              </div>
            `;
            return;
          }
          
          const response = await fetch('/generate_occasion_outfit', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              occasion: selectedOccasion
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            // Store current outfit
            currentOutfit.top = result.top;
            currentOutfit.bottom = result.bottom;
            currentOutfit.shoe = result.shoes;
            
            // Display the outfit with occasion information
            displayOutfit(result.top, result.bottom, result.shoes, `occasion-${selectedOccasion}`);
          } else {
            outfitDisplay.innerHTML = `
              <div class="alert alert-warning">
                <span class="material-symbols-outlined">warning</span>
                <span>${result.message}</span>
              </div>
            `;
          }
        } catch (error) {
          console.error("Error generating outfit:", error);
          outfitDisplay.innerHTML = `
            <div class="alert alert-warning">
              <span class="material-symbols-outlined">error</span>
              <span>Failed to generate outfit. Please try again.</span>
            </div>
          `;
        }
      }
      
      // Helper function to get hex code for color name
      function getColorHex(colorName) {
        const colorMap = {
          'black': '#000000',
          'white': '#FFFFFF',
          'navy': '#000080',
          'blue': '#0000FF',
          'red': '#FF0000',
          'green': '#008000',
          'purple': '#800080',
          'pink': '#FFC0CB',
          'yellow': '#FFFF00',
          'orange': '#FFA500',
          'brown': '#8B4513',
          'gray': '#808080',
          'beige': '#F5F5DC',
          'turquoise': '#40E0D0',
          'teal': '#008080',
          'random': 'linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet)'
        };
        
        return colorMap[colorName] || '#888888';
      }

      // Function to enlarge image when clicked
      function enlargeImage(imgElement) {
        const modal = document.getElementById("imageModal");
        const enlargedImage = document.getElementById("enlargedImage");
        const itemDetails = document.getElementById("itemDetails");
        const itemType = imgElement.getAttribute("data-type");
        
        // Set the source of the enlarged image
        enlargedImage.src = imgElement.src;
        
        // Find the item details based on type
        const item = currentOutfit[itemType];
        
        // Display item details if available
        if (item) {
          let detailsHtml = `<h3>${itemType.charAt(0).toUpperCase() + itemType.slice(1)}</h3>`;
          if (item.brand) {
            detailsHtml += `<p>Brand: ${item.brand}</p>`;
          }
          itemDetails.innerHTML = detailsHtml;
        } else {
          itemDetails.innerHTML = "";
        }
        
        // Show the modal
        modal.classList.add("show");
      }

      // Close modal when clicking the close button or outside the modal content
      document.querySelector(".close-modal").addEventListener("click", function() {
        document.getElementById("imageModal").classList.remove("show");
      });

      // Close modal when clicking outside the modal content
      document.getElementById("imageModal").addEventListener("click", function(event) {
        if (event.target === this) {
          this.classList.remove("show");
        }
      });

      // Function to save the outfit
      async function saveOutfit(topId, bottomId, shoeId) {
        try {
          const outfitName = prompt("Name your outfit:", `Outfit ${new Date().toLocaleDateString()}`);
          
          // If user canceled the prompt, don't save
          if (outfitName === null) {
            return;
          }
          
          const response = await fetch('/save_outfit', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              top_id: topId,
              bottom_id: bottomId,
              shoe_id: shoeId,
              name: outfitName
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert("Outfit saved to your favorites!");
          } else {
            alert("Error saving outfit: " + result.message);
          }
        } catch (error) {
          console.error("Error saving outfit:", error);
          alert("Failed to save outfit. Please try again.");
        }
      }

        // Toggle weather mode options when selected
        document.querySelectorAll('input[name="generationMode"]').forEach(radioBtn => {
          radioBtn.addEventListener('change', function() {
            // Update the active class for all options
            document.querySelectorAll('.option-btn').forEach(btn => {
              btn.classList.remove('active');
            });
            this.parentElement.classList.add('active');
            
            // Show/hide option sections
            const randomOptions = document.getElementById('randomOptions');
            const colorOptions = document.getElementById('colorOptions');
            const occasionOptions = document.getElementById('occasionOptions');
            const weatherOptions = document.getElementById('weatherOptions');
            
            randomOptions.style.display = 'none';
            colorOptions.style.display = 'none';
            occasionOptions.style.display = 'none';
            weatherOptions.style.display = 'none';
            
            if (this.value === 'color') {
              colorOptions.style.display = 'block';
              loadUserColorPalette();
            } else if (this.value === 'occasion') {
              occasionOptions.style.display = 'block';
            } else if (this.value === 'weather') {
              weatherOptions.style.display = 'block';
            } else {
              randomOptions.style.display = 'block';
            }
          });
        });
        
        // Weather tab functionality
        document.querySelectorAll('.weather-tab').forEach(tab => {
          tab.addEventListener('click', function() {
            // Update active tab
            document.querySelectorAll('.weather-tab').forEach(t => {
              t.classList.remove('active');
            });
            this.classList.add('active');
            
            // Show corresponding tab content
            const tabId = this.getAttribute('data-tab');
            document.querySelectorAll('.weather-tab-content').forEach(content => {
              content.style.display = 'none';
            });
            document.getElementById(tabId).style.display = 'block';
            
            // Clear any existing weather selection
            clearWeatherSelection();
          });
        });
        
        // Get weather by location
        document.getElementById('getWeatherBtn').addEventListener('click', async function() {
          const locationInput = document.getElementById('locationInput');
          const location = locationInput.value.trim();
          
          if (!location) {
            alert('Please enter a location (city name or ZIP code).');
            return;
          }
          
          try {
            // Show loading indicator
            this.innerHTML = '<span class="material-symbols-outlined spinning">refresh</span>';
            this.disabled = true;
            
            const response = await fetch('/get_weather', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ location: location })
            });
            
            const result = await response.json();
            
            // Reset button
            this.innerHTML = '<span class="material-symbols-outlined">search</span> Get Weather';
            this.disabled = false;
            
            if (result.success) {
              // Display weather info
              document.getElementById('weatherInfo').style.display = 'block';
              document.getElementById('weatherLocation').textContent = result.location;
              document.getElementById('weatherTemp').textContent = result.temperature;
              document.getElementById('weatherCondition').textContent = result.weather_description;
              
              // Set weather icon based on condition
              const weatherIcon = document.getElementById('weatherIcon');
              switch(result.weather_condition) {
                case 'sunny':
                  weatherIcon.textContent = 'sunny';
                  break;
                case 'cloudy':
                  weatherIcon.textContent = 'cloud';
                  break;
                case 'rain':
                  weatherIcon.textContent = 'rainy';
                  break;
                case 'snow':
                  weatherIcon.textContent = 'ac_unit';
                  break;
                default:
                  weatherIcon.textContent = 'thermostat';
              }
              
              // Update the selected weather display
              document.getElementById('selectedWeatherDisplay').textContent = 
                `Selected: ${result.temperature}°F, ${result.weather_description}`;
              document.getElementById('clearWeatherSelection').style.display = 'inline-flex';
              
              // Store the weather data for outfit generation
              weatherData = {
                temperature: result.temperature,
                weather_condition: result.weather_condition,
                weather_description: result.weather_description
              };
            } else {
              alert(`Error: ${result.message}`);
            }
          } catch (error) {
            console.error('Error getting weather:', error);
            this.innerHTML = '<span class="material-symbols-outlined">search</span> Get Weather';
            this.disabled = false;
            alert('Failed to fetch weather data. Please try again.');
          }
        });
        
        // Manual weather condition selection
        document.querySelectorAll('.weather-condition-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            // Toggle active state
            document.querySelectorAll('.weather-condition-btn').forEach(b => {
              b.classList.remove('active');
            });
            this.classList.add('active');
            
            updateManualWeatherSelection();
          });
        });
        
        // Temperature input change
        document.getElementById('temperatureInput').addEventListener('input', function() {
          updateManualWeatherSelection();
        });
        
        // Update manual weather selection
        function updateManualWeatherSelection() {
          const selectedConditionBtn = document.querySelector('.weather-condition-btn.active');
          const temperatureInput = document.getElementById('temperatureInput');
          
          if (selectedConditionBtn && temperatureInput.value) {
            const condition = selectedConditionBtn.getAttribute('data-condition');
            const temperature = parseInt(temperatureInput.value);
            
            // Update the selected weather display
            document.getElementById('selectedWeatherDisplay').textContent = 
              `Selected: ${temperature}°F, ${condition.charAt(0).toUpperCase() + condition.slice(1)}`;
            document.getElementById('clearWeatherSelection').style.display = 'inline-flex';
            
            // Store the weather data for outfit generation
            weatherData = {
              temperature: temperature,
              weather_condition: condition,
              weather_description: condition
            };
          } else {
            document.getElementById('selectedWeatherDisplay').textContent = 'No weather conditions selected';
            document.getElementById('clearWeatherSelection').style.display = 'none';
            weatherData = null;
          }
        }
        
        // Clear weather selection
        document.getElementById('clearWeatherSelection').addEventListener('click', function() {
          clearWeatherSelection();
        });
        
        function clearWeatherSelection() {
          // Reset location tab
          document.getElementById('weatherInfo').style.display = 'none';
          document.getElementById('locationInput').value = '';
          
          // Reset manual tab
          document.querySelectorAll('.weather-condition-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          document.getElementById('temperatureInput').value = '70';
          
          // Reset selection info
          document.getElementById('selectedWeatherDisplay').textContent = 'No weather conditions selected';
          document.getElementById('clearWeatherSelection').style.display = 'none';
          
          // Clear weather data
          weatherData = null;
        }
        
        // Global variable to store weather data
        let weatherData = null;
        
        // Modify the generateOutfit function to handle weather-based generation
        async function generateOutfit() {
          const mode = document.querySelector('input[name="generationMode"]:checked').value;
          
          if (mode === 'random') {
            await generateRandomOutfit();
          } else if (mode === 'color') {
            await generateColorOutfit();
          } else if (mode === 'occasion') {
            await generateOccasionOutfit();
          } else if (mode === 'weather') {
            await generateWeatherOutfit();
          }
        }
        
        // Add the weather-based outfit generation function
        async function generateWeatherOutfit() {
          const outfitDisplay = document.getElementById("outfitDisplay");
          
          try {
            // Check if weather data is available
            if (!weatherData) {
              outfitDisplay.innerHTML = `
                <div class="alert alert-warning">
                  <span class="material-symbols-outlined">thermostat</span>
                  <span>Please select weather conditions first.</span>
                </div>
              `;
              return;
            }
            
            // Show loading state
            outfitDisplay.innerHTML = `
              <div class="loading-spinner">
                <span class="material-symbols-outlined spinning">refresh</span>
                <p>Generating weather-based outfit for ${weatherData.temperature}°F, ${weatherData.weather_description}...</p>
              </div>
            `;
            
            const response = await fetch('/generate_weather_outfit', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                temperature: weatherData.temperature,
                weather_condition: weatherData.weather_condition
              })
            });
            
            const result = await response.json();
            
            if (result.success) {
              // Store current outfit
              currentOutfit.top = result.top;
              currentOutfit.bottom = result.bottom;
              currentOutfit.shoe = result.shoes;
              
              // Create weather badge based on condition
              let weatherIcon = '';
              switch (weatherData.weather_condition) {
                case 'sunny':
                  weatherIcon = 'sunny';
                  break;
                case 'cloudy':
                  weatherIcon = 'cloud';
                  break;
                case 'rain':
                  weatherIcon = 'rainy';
                  break;
                case 'snow':
                  weatherIcon = 'ac_unit';
                  break;
                default:
                  weatherIcon = 'thermostat';
              }
              
              // Display the outfit with weather information
              displayOutfit(
                result.top, 
                result.bottom, 
                result.shoes, 
                `weather-${weatherData.weather_condition}`,
                `<span class="material-symbols-outlined">${weatherIcon}</span> ${weatherData.temperature}°F, ${weatherData.weather_description}`
              );
            } else {
              outfitDisplay.innerHTML = `
                <div class="alert alert-warning">
                  <span class="material-symbols-outlined">warning</span>
                  <span>${result.message}</span>
                </div>
              `;
            }
          } catch (error) {
            console.error("Error generating outfit:", error);
            outfitDisplay.innerHTML = `
              <div class="alert alert-warning">
                <span class="material-symbols-outlined">error</span>
                <span>Failed to generate outfit. Please try again.</span>
              </div>
            `;
          }
        }
        
        // Display outfit in the UI
        function displayOutfit(top, bottom, shoe, coordinationStyle = null, customBadgeContent = null) {
          const outfitDisplay = document.getElementById("outfitDisplay");
          
          // Check if this is a complete top outfit (dress/jumpsuit/etc.)
          const isCompleteTop = !bottom || top.is_complete_top === true;
          
          // Style label for coordination type
          let styleLabel = '';
          
          // Check if we have a color-specific coordination style
          if (coordinationStyle && coordinationStyle.startsWith('color-coordinated-')) {
            // Extract the color name from the style
            const baseColor = coordinationStyle.replace('color-coordinated-', '');
            styleLabel = `
              <div class="coordination-badge">
                <span class="material-symbols-outlined">palette</span>
                ${baseColor.charAt(0).toUpperCase() + baseColor.slice(1)} Coordinated Outfit
                <span class="color-dot" style="background-color: ${getColorHex(baseColor)};"></span>
              </div>
            `;
          } else if (coordinationStyle && coordinationStyle.startsWith('occasion-')) {
            // Extract the occasion name from the style
            const occasion = coordinationStyle.replace('occasion-', '');
            
            // Select appropriate icon for each occasion
            let occasionIcon = 'event';
            if (occasion === 'casual') occasionIcon = 'weekend';
            else if (occasion === 'work/professional') occasionIcon = 'business_center';
            else if (occasion === 'formal') occasionIcon = 'local_bar';
            else if (occasion === 'athletic/sport') occasionIcon = 'fitness_center';
            else if (occasion === 'lounge/sleepwear') occasionIcon = 'hotel';
            
            styleLabel = `
              <div class="coordination-badge occasion-badge">
                <span class="material-symbols-outlined">${occasionIcon}</span>
                ${occasion.charAt(0).toUpperCase() + occasion.slice(1)} Outfit
              </div>
            `;
          } else if (coordinationStyle && coordinationStyle.startsWith('weather-')) {
            // Extract the weather condition from the style
            const weatherCondition = coordinationStyle.replace('weather-', '');
            
            // Use custom badge content if provided, otherwise create a standard one
            if (customBadgeContent) {
              styleLabel = `
                <div class="coordination-badge weather-badge">
                  ${customBadgeContent}
                </div>
              `;
            } else {
              // Select appropriate icon for each weather condition
              let weatherIcon = 'thermostat';
              if (weatherCondition === 'sunny') weatherIcon = 'sunny';
              else if (weatherCondition === 'cloudy') weatherIcon = 'cloud';
              else if (weatherCondition === 'rain') weatherIcon = 'rainy';
              else if (weatherCondition === 'snow') weatherIcon = 'ac_unit';
              
              styleLabel = `
                <div class="coordination-badge weather-badge">
                  <span class="material-symbols-outlined">${weatherIcon}</span>
                  ${weatherCondition.charAt(0).toUpperCase() + weatherCondition.slice(1)} Weather Outfit
                </div>
              `;
            }
          } else if (coordinationStyle === 'color-coordinated') {
            styleLabel = `
              <div class="coordination-badge">
                <span class="material-symbols-outlined">palette</span>
                Color Coordinated
              </div>
            `;
          }
          
          // Build the outfit HTML
          let outfitHtml = `
            <div class="outfit">
              ${styleLabel}
              <div class="outfit-item">
                <div class="item-label">${isCompleteTop ? 'Dress/Complete' : 'Top'}</div>
                <div class="item-image-container">
                  ${top.unavailable ? '<div class="unavailable-outfit-badge tooltip"><span class="material-symbols-outlined">do_not_disturb_on</span><span class="tooltip-text">This item is unavailable/dirty</span></div>' : ''}
                  <img src="${top.image_url}" alt="Top" data-type="top" onclick="enlargeImage(this)">
                </div>
              </div>
          `;
          
          // Only include bottom section if this is not a complete top
          if (!isCompleteTop) {
            outfitHtml += `
              <div class="outfit-item">
                <div class="item-label">Bottom</div>
                <div class="item-image-container">
                  ${bottom && bottom.unavailable ? '<div class="unavailable-outfit-badge tooltip"><span class="material-symbols-outlined">do_not_disturb_on</span><span class="tooltip-text">This item is unavailable/dirty</span></div>' : ''}
                  <img src="${bottom.image_url}" alt="Bottom" data-type="bottom" onclick="enlargeImage(this)">
                </div>
              </div>
            `;
          }
          
          // Complete the outfit HTML with shoes and save button
          outfitHtml += `
              <div class="outfit-item">
                <div class="item-label">Shoes</div>
                <div class="item-image-container">
                  ${shoe.unavailable ? '<div class="unavailable-outfit-badge tooltip"><span class="material-symbols-outlined">do_not_disturb_on</span><span class="tooltip-text">This item is unavailable/dirty</span></div>' : ''}
                  <img src="${shoe.image_url}" alt="Shoes" data-type="shoe" onclick="enlargeImage(this)">
                </div>
              </div>
            </div>
            <button id="saveOutfitBtn" class="btn save-btn">
              <span class="material-symbols-outlined">bookmark</span>
              Save This Outfit
            </button>
          `;
          
          // Update the display
          outfitDisplay.innerHTML = outfitHtml;
          
          // Add event listener to the save button if it exists
          const saveButton = document.getElementById("saveOutfitBtn");
          if (saveButton) {
            saveButton.addEventListener("click", function() {
              // Pass bottom ID as null for complete tops
              saveOutfit(top.id, isCompleteTop ? null : bottom.id, shoe.id);
            });
          }
        }

      // Main generation function based on selected mode
      async function generateOutfit() {
        const mode = document.querySelector('input[name="generationMode"]:checked').value;
        
        if (mode === 'random') {
          await generateRandomOutfit();
        } else if (mode === 'color') {
          await generateColorOutfit();
        } else if (mode === 'occasion') {
          await generateOccasionOutfit();
        } else if (mode === 'weather') {
          await generateWeatherOutfit();
        }
      }
      
      // Initialize the options display based on default selection
      window.addEventListener('DOMContentLoaded', function() {
        // Show random options by default since it's the default selected option
        document.getElementById('randomOptions').style.display = 'block';
        document.getElementById('colorOptions').style.display = 'none';
        document.getElementById('occasionOptions').style.display = 'none';
        
        // Set up clear selection button for color mode
        const clearColorBtn = document.getElementById('clearColorSelection');
        clearColorBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          document.querySelectorAll('.color-chip').forEach(c => c.classList.remove('selected'));
          document.getElementById('selectedColorDisplay').textContent = "No color selected";
          this.style.display = 'none';
        });
        
        // Set up occasion button listeners
        setupOccasionButtonListeners();
      });

      document
        .getElementById("generateBtn")
        .addEventListener("click", generateOutfit);
    </script>
  </body>
</html>